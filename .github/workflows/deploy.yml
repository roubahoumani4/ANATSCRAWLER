name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Prepare deployment directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 46.165.254.175
          port: 50103
          username: ituu
          key: \${{ secrets.SSH_PRIVATE_KEY }}
          use_insecure_cipher: true
          script: |
            DEPLOY_DIR="/var/www/anatscrawler-\$(date +%Y%m%d%H%M%S)"
            echo "Creating deployment directory: \$DEPLOY_DIR"
            echo 'Klapauciusa12' | sudo -S mkdir -p \$DEPLOY_DIR
            echo 'Klapauciusa12' | sudo -S chown ituu:ituu \$DEPLOY_DIR
            echo 'Klapauciusa12' | sudo -S chmod 755 \$DEPLOY_DIR
            echo "export DEPLOY_DIR=\$DEPLOY_DIR" > /tmp/deploy_dir.sh

      - name: Deploy Files
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 46.165.254.175
          port: 50103
          username: ituu
          key: \${{ secrets.SSH_PRIVATE_KEY }}
          use_insecure_cipher: true
          script: |
            source /tmp/deploy_dir.sh
            TEMP_DIR=\$(mktemp -d)
            git clone https://github.com/roubahoumani4/ANATSCRAWLER.git \$TEMP_DIR
            echo 'Klapauciusa12' | sudo -S cp -r \$TEMP_DIR/* \$DEPLOY_DIR/
            echo 'Klapauciusa12' | sudo -S cp -r \$TEMP_DIR/.* \$DEPLOY_DIR/ 2>/dev/null || true
            rm -rf \$TEMP_DIR
            echo 'Klapauciusa12' | sudo -S chown -R ituu:ituu \$DEPLOY_DIR
            echo 'Klapauciusa12' | sudo -S chmod -R 755 \$DEPLOY_DIR

      - name: Configure and Start Application
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 46.165.254.175
          port: 50103
          username: ituu
          key: \${{ secrets.SSH_PRIVATE_KEY }}
          use_insecure_cipher: true
          script: |
            source /tmp/deploy_dir.sh
            cd \$DEPLOY_DIR

            echo '{"type":"module"}' > package.json.tmp
            cat package.json >> package.json.tmp
            mv package.json.tmp package.json

            echo 'Klapauciusa12' | sudo -S chown -R ituu:ituu .
            echo 'Klapauciusa12' | sudo -S chmod -R 755 .

            # Setup environment file
            touch .env
            echo 'Klapauciusa12' | sudo -S chown ituu:ituu .env
            echo 'Klapauciusa12' | sudo -S chmod 600 .env
            echo "NODE_ENV=production" > .env
            echo "PORT=5000" >> .env
            echo "HOST=0.0.0.0" >> .env
            echo "ELASTICSEARCH_URL=http://192.168.1.110:9200" >> .env
            echo "MONGODB_URL=mongodb://192.168.1.110:27017/anat_security" >> .env
            echo "REDIS_URL=redis://192.168.1.110:6379" >> .env
            echo "VITE_API_URL=/api" >> .env
            echo "JWT_SECRET=NWagPsTDSNKzcgJQvYouOyTwCbQ0ZTG+zE3/8eTPqQM=" >> .env
            echo "COOKIE_SECRET=NnnQPZ8wazuVR26qNCZ9wRXAdUipV/sE/jC+mKizTXg=" >> .env

            # Install dependencies and build
            npm ci
            echo 'Klapauciusa12' | sudo -S apt-get update
            echo 'Klapauciusa12' | sudo -S apt-get install -y xvfb

            export DISPLAY=:99
            export QT_QPA_PLATFORM=offscreen
            export NODE_ENV=production

            echo 'Klapauciusa12' | sudo -S Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
            sleep 3

            npm run build

            if [ ! -f "dist/index.js" ]; then
              echo "âŒ Build failed: dist/index.js not found"
              exit 1
            fi

            npm ci --omit=dev

            # Setup PM2 configuration
            echo 'module.exports = {
              apps: [{
                name: "anatscrawler",
                script: "dist/index.js",
                node_args: "--experimental-specifier-resolution=node",
                env: {
                  NODE_ENV: "production",
                  PORT: "5000",
                  HOST: "0.0.0.0",
                  TRUST_PROXY: "true",
                  ELASTICSEARCH_URL: "http://192.168.1.110:9200",
                  MONGODB_URL: "mongodb://192.168.1.110:27017/anat_security",
                  REDIS_URL: "redis://192.168.1.110:6379",
                  JWT_SECRET: "NWagPsTDSNKzcgJQvYouOyTwCbQ0ZTG+zE3/8eTPqQM=",
                  COOKIE_SECRET: "NnnQPZ8wazuVR26qNCZ9wRXAdUipV/sE/jC+mKizTXg="
                },
                instances: "1",
                exec_mode: "fork",
                max_memory_restart: "1G",
                watch: false,
                error_file: "logs/err.log",
                out_file: "logs/out.log",
                merge_logs: true,
                log_date_format: "YYYY-MM-DD HH:mm:ss",
                listen_timeout: 10000,
                kill_timeout: 5000,
                wait_ready: true
              }]
            }' > ecosystem.config.cjs

            mkdir -p logs
            pm2 delete anatscrawler || true
            pm2 start ecosystem.config.cjs

            CURRENT_LINK="/var/www/anatscrawler"
            if [ -L "\$CURRENT_LINK" ]; then
              sudo rm "\$CURRENT_LINK"
            fi
            sudo ln -sf "\$DEPLOY_DIR" "\$CURRENT_LINK"

            if [ -d "\$DEPLOY_DIR/client/dist" ]; then
              echo "Moving client dist files to the correct location..."
              mv \$DEPLOY_DIR/client/dist/* \$DEPLOY_DIR/client/
              rm -rf \$DEPLOY_DIR/client/dist
            fi

            cd /var/www
            ls -1dt anatscrawler-* | tail -n +6 | xargs -r sudo rm -rf
            pm2 save

            echo "âœ… Deployment completed successfully!"
            echo "ðŸ“Š Current PM2 status:"
            pm2 ls

            echo "ðŸ“Š Network status:"
            netstat -tln | grep LISTEN
