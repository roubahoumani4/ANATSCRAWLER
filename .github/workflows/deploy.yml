name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Prepare deployment directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 46.165.254.175
          port: 50103
          username: ituu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          use_insecure_cipher: true
          script: |
            DEPLOY_DIR="/var/www/anatscrawler-$(date +%Y%m%d%H%M%S)"
            echo "Creating deployment directory: $DEPLOY_DIR"
            echo 'Klapauciusa12' | sudo -S mkdir -p $DEPLOY_DIR
            echo 'Klapauciusa12' | sudo -S chown ituu:ituu $DEPLOY_DIR
            echo 'Klapauciusa12' | sudo -S chmod 755 $DEPLOY_DIR
            # Store the deploy dir for later use in the script
            echo "export DEPLOY_DIR=$DEPLOY_DIR" > /tmp/deploy_dir.sh

      - name: Deploy Files
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 46.165.254.175
          port: 50103
          username: ituu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          use_insecure_cipher: true
          script: |
            # Source the deploy directory
            source /tmp/deploy_dir.sh
            
            # Create a temporary directory for the files
            TEMP_DIR=$(mktemp -d)
            
            # Clone the repository to the temporary directory
            git clone https://github.com/roubahoumani4/ANATSCRAWLER.git $TEMP_DIR
            
            # Copy files to deployment directory with sudo
            echo 'Klapauciusa12' | sudo -S cp -r $TEMP_DIR/* $DEPLOY_DIR/
            echo 'Klapauciusa12' | sudo -S cp -r $TEMP_DIR/.* $DEPLOY_DIR/ 2>/dev/null || true
            
            # Clean up temp directory
            rm -rf $TEMP_DIR
            
            # Set proper ownership and permissions
            echo 'Klapauciusa12' | sudo -S chown -R ituu:ituu $DEPLOY_DIR
            echo 'Klapauciusa12' | sudo -S chmod -R 755 $DEPLOY_DIR

      - name: Configure and Start Application
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 46.165.254.175
          port: 50103
          username: ituu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          use_insecure_cipher: true
          script: |
            # Source the deploy directory
            source /tmp/deploy_dir.sh
            cd $DEPLOY_DIR

            # Ensure proper permissions
            echo 'Klapauciusa12' | sudo -S chown -R ituu:ituu .
            echo 'Klapauciusa12' | sudo -S chmod -R 755 .

            # Create/update .env file with proper permissions
            touch .env
            echo 'Klapauciusa12' | sudo -S chown ituu:ituu .env
            echo 'Klapauciusa12' | sudo -S chmod 600 .env
            cat > .env << EOL
            NODE_ENV=production
            PORT=5000
            ELASTICSEARCH_URL=http://192.168.1.110:9200
            MONGODB_URL=mongodb://192.168.1.110:27017/anat_security
            REDIS_URL=redis://192.168.1.110:6379
            VITE_API_URL=/api
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            COOKIE_SECRET=${{ secrets.COOKIE_SECRET }}
            EOL

            # Install dependencies
            npm ci --production

            # Build the application
            npm run build

            # Create PM2 configuration file
            cat > ecosystem.config.cjs << 'EOL'
            module.exports = {
              apps: [{
                name: 'anatscrawler',
                script: 'dist/index.js',
                env: {
                  NODE_ENV: 'production',
                  PORT: '5000',
                  HOST: '0.0.0.0',
                  TRUST_PROXY: 'true',
                  ELASTICSEARCH_URL: 'http://192.168.1.110:9200',
                  MONGODB_URL: 'mongodb://192.168.1.110:27017/anat_security',
                  REDIS_URL: 'redis://192.168.1.110:6379'
                },
                instances: 'max',
                exec_mode: 'cluster',
                max_memory_restart: '1G',
                watch: false,
                error_file: 'logs/err.log',
                out_file: 'logs/out.log',
                merge_logs: true,
                log_date_format: 'YYYY-MM-DD HH:mm:ss'
              }]
            }
            EOL

            # Create logs directory
            mkdir -p logs

            # Stop existing PM2 process if it exists
            pm2 delete anatscrawler || true

            # Start new application
            pm2 start ecosystem.config.cjs

            # Update symlink for zero-downtime deployment
            CURRENT_LINK="/var/www/anatscrawler"
            if [ -L "$CURRENT_LINK" ]; then
              sudo rm "$CURRENT_LINK"
            fi
            sudo ln -sf "$DEPLOY_DIR" "$CURRENT_LINK"

            # Clean up old deployments (keep last 5)
            cd /var/www
            ls -1dt anatscrawler-* | tail -n +6 | xargs -r sudo rm -rf

            # Save PM2 process list
            pm2 save

            echo "âœ… Deployment completed successfully!"
            echo "ðŸ“Š Current PM2 status:"
            pm2 ls
