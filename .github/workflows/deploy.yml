name: Deploy to Production

on:
  push:
    branches:
      - main

env:
  DEPLOY_BASE_DIR: /var/www/anatscrawler
  KEEP_VERSIONS: 2

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Create new deployment directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          port: ${{ secrets.DEPLOY_PORT }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SUDO_PASSWORD }}
          use_insecure_cipher: true
          script: |
            # Create timestamp-based deployment directory
            DEPLOY_BASE=/var/www/anatscrawler
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            DEPLOY_DIR="${DEPLOY_BASE}-${TIMESTAMP}"
            
            echo "Setting up deployment directories..."
            echo ${{ secrets.SUDO_PASSWORD }} | sudo -S mkdir -p /var/www
            echo ${{ secrets.SUDO_PASSWORD }} | sudo -S chown -R $USER:$USER /var/www
            echo ${{ secrets.SUDO_PASSWORD }} | sudo -S chmod 755 /var/www
            
            echo "Creating deployment directory: $DEPLOY_DIR"
            mkdir -p $DEPLOY_DIR || {
              echo "Failed to create directory"
              exit 1
            }
            
            # Save deployment information
            echo "DEPLOY_DIR=$DEPLOY_DIR" > /tmp/deploy_vars
            echo "TIMESTAMP=$TIMESTAMP" >> /tmp/deploy_vars
            echo "DEPLOY_BASE=$DEPLOY_BASE" >> /tmp/deploy_vars
            
            # Verify directory was created
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Failed to create deployment directory"
              exit 1
            fi
            
            echo "Successfully created deployment directory: $DEPLOY_DIR"

      - name: Deploy Files
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          port: ${{ secrets.DEPLOY_PORT }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          use_insecure_cipher: true
          script: |
            # Load deployment variables
            if [ ! -f /tmp/deploy_vars ]; then
              echo "Deployment variables file not found"
              exit 1
            fi
            source /tmp/deploy_vars
            
            if [ -z "$DEPLOY_DIR" ]; then
              echo "DEPLOY_DIR variable not set"
              exit 1
            fi
            
            # Create temporary directory for cloning
            TEMP_DIR=$(mktemp -d)
            echo "Created temporary directory: $TEMP_DIR"
            
            # Clone repository
            echo "Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git $TEMP_DIR || {
              echo "Failed to clone repository"
              rm -rf $TEMP_DIR
              exit 1
            }
            
            # Copy files
            echo "Copying files to $DEPLOY_DIR..."
            cp -r $TEMP_DIR/* $DEPLOY_DIR/ || {
              echo "Failed to copy files"
              rm -rf $TEMP_DIR
              exit 1
            }
            
            # Copy hidden files
            cp -r $TEMP_DIR/.* $DEPLOY_DIR/ 2>/dev/null || true
            
            # Cleanup
            rm -rf $TEMP_DIR
            echo "Cleaned up temporary directory"
            
            # Set permissions
            chmod -R 755 $DEPLOY_DIR || {
              echo "Failed to set permissions"
              exit 1
            }
            
            echo "Successfully deployed files to: $DEPLOY_DIR"

      - name: Configure and Build Application
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          port: ${{ secrets.DEPLOY_PORT }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          use_insecure_cipher: true
          script: |
            source /tmp/deploy_vars
            cd $DEPLOY_DIR

            # Setup environment file
            cat << EOF > .env
            NODE_ENV=production
            PORT=${{ secrets.APP_PORT }}
            HOST=0.0.0.0
            ELASTICSEARCH_URL=${{ secrets.ELASTICSEARCH_URL }}
            MONGODB_URL=${{ secrets.MONGODB_URL }}
            REDIS_URL=${{ secrets.REDIS_URL }}
            VITE_API_URL=/api
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            COOKIE_SECRET=${{ secrets.COOKIE_SECRET }}
            EOF
            
            chmod 600 .env

            # Install dependencies and build
            echo "Installing dependencies..."
            npm ci
            
            # Install system dependencies
            sudo -S apt-get update
            sudo -S apt-get install -y xvfb

            # Setup display for tests
            export DISPLAY=:99
            export QT_QPA_PLATFORM=offscreen
            export NODE_ENV=production

            sudo -S Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
            sleep 3

            echo "Building application..."
            npm run build

            # Validate build
            if [ ! -f "dist/index.js" ]; then
              echo "âŒ Build failed: dist/index.js not found"
              exit 1
            fi

      - name: Update Service and Cleanup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          port: ${{ secrets.DEPLOY_PORT }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          use_insecure_cipher: true
          envs: DEPLOY_BASE_DIR,KEEP_VERSIONS
          script: |
            source /tmp/deploy_vars
            
            # Update PM2 service
            cd $DEPLOY_DIR
            
            echo "Updating PM2 service..."
            if pm2 list | grep -q "anatscrawler"; then
              pm2 delete anatscrawler
            fi
            
            pm2 start dist/index.js --name anatscrawler
            pm2 save
            
            # Create/Update symlink
            CURRENT_LINK="${DEPLOY_BASE_DIR}-current"
            sudo -S rm -f $CURRENT_LINK
            sudo -S ln -s $DEPLOY_DIR $CURRENT_LINK
            
            # Cleanup old deployments
            echo "Cleaning up old deployments..."
            cd /var/www
            ls -1dt ${DEPLOY_BASE_DIR}-* | grep -v "${DEPLOY_BASE_DIR}-current" | tail -n +$((KEEP_VERSIONS + 1)) | while read dir; do
              echo "Removing old deployment: $dir"
              sudo -S rm -rf "$dir"
            done
            
            # Validate deployment
            if ! curl -s http://localhost:${{ secrets.APP_PORT }}/health | grep -q "ok"; then
              echo "âŒ Health check failed"
              
              # Rollback to previous version if available
              PREV_DEPLOY=$(ls -1dt ${DEPLOY_BASE_DIR}-* | grep -v "${DEPLOY_BASE_DIR}-current" | head -n 1)
              if [ -n "$PREV_DEPLOY" ]; then
                echo "Rolling back to: $PREV_DEPLOY"
                sudo -S ln -sf $PREV_DEPLOY $CURRENT_LINK
                cd $PREV_DEPLOY
                pm2 delete anatscrawler
                pm2 start dist/index.js --name anatscrawler
                pm2 save
              fi
              
              exit 1
            fi
            
            echo "âœ… Deployment successful"
              echo "Contents of project root:"
              ls -la
              echo "Contents of dist directory (if exists):"
              ls -la dist/ || echo "dist directory does not exist"
              exit 1
            fi
            echo "âœ… Server build successful: dist/index.js found"

            # Validate client build - check multiple possible locations
            CLIENT_BUILD_FOUND=false
            if [ -f "client/dist/index.html" ]; then
              echo "âœ… Client build successful: client/dist/index.html found"
              CLIENT_BUILD_FOUND=true
            elif [ -f "client/index.html" ]; then
              echo "âœ… Client build found at: client/index.html (alternative location)"
              CLIENT_BUILD_FOUND=true
            elif [ -f "dist/client/index.html" ]; then
              echo "âœ… Client build found at: dist/client/index.html (alternative location)"
              CLIENT_BUILD_FOUND=true
            fi
            
            if [ "$CLIENT_BUILD_FOUND" = false ]; then
              echo "âŒ Client build failed: index.html not found in expected locations"
              echo "Contents of client directory:"
              ls -la client/ || echo "client directory does not exist"
              echo "Contents of client/dist directory (if exists):"
              ls -la client/dist/ || echo "client/dist directory does not exist"
              echo "Contents of dist directory:"
              ls -la dist/ || echo "dist directory does not exist"
              echo "Searching for index.html files:"
              find . -name "index.html" -type f | head -10
              exit 1
            fi

            # List deployment directory contents for debugging
            echo "ðŸ“ Deployment directory contents:"
            find . -type f -name "*.html" -o -name "*.js" -o -name "*.css" | head -20

            # Clean up dev dependencies
            npm ci --omit=dev

            # Setup PM2 configuration with proper CommonJS syntax
            echo "module.exports = {" > ecosystem.config.cjs
            echo "  apps: [{" >> ecosystem.config.cjs
            echo "    name: 'anatscrawler'," >> ecosystem.config.cjs
            echo "    script: 'dist/index.js'," >> ecosystem.config.cjs
            echo "    env: {" >> ecosystem.config.cjs
            echo "      NODE_ENV: 'production'," >> ecosystem.config.cjs
            echo "      PORT: '5000'," >> ecosystem.config.cjs
            echo "      HOST: '0.0.0.0'," >> ecosystem.config.cjs
            echo "      TRUST_PROXY: 'true'," >> ecosystem.config.cjs
            echo "      ELASTICSEARCH_URL: 'http://192.168.1.110:9200'," >> ecosystem.config.cjs
            echo "      MONGODB_URL: 'mongodb://192.168.1.110:27017/anat_security'," >> ecosystem.config.cjs
            echo "      REDIS_URL: 'redis://192.168.1.110:6379'," >> ecosystem.config.cjs
            echo "      JWT_SECRET: 'NWagPsTDSNKzcgJQvYouOyTwCbQ0ZTG+zE3/8eTPqQM='," >> ecosystem.config.cjs
            echo "      COOKIE_SECRET: 'NnnQPZ8wazuVR26qNCZ9wRXAdUipV/sE/jC+mKizTXg='" >> ecosystem.config.cjs
            echo "    }," >> ecosystem.config.cjs
            echo "    instances: 1," >> ecosystem.config.cjs
            echo "    exec_mode: 'fork'," >> ecosystem.config.cjs
            echo "    max_memory_restart: '1G'," >> ecosystem.config.cjs
            echo "    watch: false," >> ecosystem.config.cjs
            echo "    error_file: 'logs/err.log'," >> ecosystem.config.cjs
            echo "    out_file: 'logs/out.log'," >> ecosystem.config.cjs
            echo "    merge_logs: true," >> ecosystem.config.cjs
            echo "    log_date_format: 'YYYY-MM-DD HH:mm:ss'," >> ecosystem.config.cjs
            echo "    listen_timeout: 10000," >> ecosystem.config.cjs
            echo "    kill_timeout: 5000" >> ecosystem.config.cjs
            echo "  }]" >> ecosystem.config.cjs
            echo "}" >> ecosystem.config.cjs

            mkdir -p logs
            
            # Stop existing PM2 process
            pm2 delete anatscrawler || true
            
            # Start new application
            pm2 start ecosystem.config.cjs
            
            # Wait for application to start
            sleep 10
            
            # Verify the application is running and listening
            if pm2 show anatscrawler | grep -q "online"; then
              echo "âœ… PM2 process is online"
              pm2 show anatscrawler
            else
              echo "âŒ PM2 process failed to start"
              echo "PM2 Status:"
              pm2 ls
              echo "PM2 Logs:"
              pm2 logs anatscrawler --lines 50
              exit 1
            fi
            
            # Check if port 5000 is listening with more detailed output
            RETRIES=15
            PORT_LISTENING=false
            while [ $RETRIES -gt 0 ]; do
              if netstat -tln | grep -q ":5000"; then
                echo "âœ… Server is listening on port 5000"
                PORT_LISTENING=true
                break
              else
                echo "â³ Waiting for server to start listening on port 5000... ($RETRIES retries left)"
                echo "Current listening ports:"
                netstat -tln | grep LISTEN
                sleep 3
                RETRIES=$((RETRIES - 1))
              fi
            done
            
            if [ "$PORT_LISTENING" = false ]; then
              echo "âŒ Server failed to listen on port 5000 after waiting"
              echo "Final PM2 Status:"
              pm2 ls
              echo "Final PM2 Logs:"
              pm2 logs anatscrawler --lines 100
              echo "Process Details:"
              pm2 show anatscrawler
              echo "System Processes on port 5000:"
              lsof -i :5000 || echo "No processes found on port 5000"
              exit 1
            fi

            # Test server responses to ensure it's working correctly
            echo "ðŸ” Testing server endpoints..."
            
            # Test health endpoint first
            HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api/health --connect-timeout 10 || echo "000")
            if [ "$HEALTH_RESPONSE" = "200" ]; then
              echo "âœ… Health endpoint responding correctly"
            else
              echo "âš ï¸  Health endpoint issue (HTTP $HEALTH_RESPONSE)"
            fi
            
            # Test root endpoint
            ROOT_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/ --connect-timeout 10 || echo "000")
            if [ "$ROOT_RESPONSE" = "200" ]; then
              echo "âœ… Root endpoint serving client files correctly"
            elif [ "$ROOT_RESPONSE" = "404" ]; then
              echo "âš ï¸  Root endpoint returns 404 - may indicate client file issues"
              echo "Checking PM2 logs for client file errors:"
              pm2 logs anatscrawler --lines 20 | grep -i "client\|index.html\|static" || echo "No client-related errors in recent logs"
            else
              echo "âš ï¸  Root endpoint unexpected response (HTTP $ROOT_RESPONSE)"
            fi

            # Update symlink for zero-downtime deployment
            CURRENT_LINK="/var/www/anatscrawler"
            if [ -L "$CURRENT_LINK" ]; then
              echo "Removing existing symlink: $CURRENT_LINK"
              echo 'Klapauciusa12' | sudo -S rm "$CURRENT_LINK"
            fi
            echo "Creating new symlink: $CURRENT_LINK -> $DEPLOY_DIR"
            echo 'Klapauciusa12' | sudo -S ln -sf "$DEPLOY_DIR" "$CURRENT_LINK"

            # Verify static files are accessible
            echo "ðŸ” Verifying static files are accessible..."
            if [ -f "client/dist/index.html" ]; then
              echo "âœ… index.html found at: $(pwd)/client/dist/index.html"
              ls -la client/dist/index.html
            else
              echo "âš ï¸  Warning: index.html not found in expected location"
              find . -name "index.html" -type f | head -5
            fi

            # Test a simple HTTP request to the server
            echo "ðŸ” Testing server response..."
            CURL_TEST=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/ || echo "000")
            if [ "$CURL_TEST" = "200" ] || [ "$CURL_TEST" = "404" ]; then
              echo "âœ… Server is responding (HTTP $CURL_TEST)"
            else
              echo "âš ï¸  Server response test: HTTP $CURL_TEST"
            fi

            # Clean up old deployments (keep last 5)
            echo "ðŸ§¹ Cleaning up old deployments..."
            cd /var/www
            OLD_DEPLOYMENTS=$(ls -1dt anatscrawler-* 2>/dev/null | tail -n +6)
            if [ -n "$OLD_DEPLOYMENTS" ]; then
              echo "Removing old deployments:"
              echo "$OLD_DEPLOYMENTS"
              echo "$OLD_DEPLOYMENTS" | xargs -r echo 'Klapauciusa12' | sudo -S rm -rf
            else
              echo "No old deployments to clean up"
            fi
            
            # Save PM2 process list
            pm2 save

            echo "ðŸŽ‰ Deployment completed successfully!"
            echo "ðŸ“Š Final PM2 status:"
            pm2 ls
            echo "ðŸ“Š Final network status:"
            netstat -tln | grep LISTEN | grep 5000
            echo "ðŸ“Š Deployment summary:"
            echo "  - Server: $(pm2 show anatscrawler | grep 'status' || echo 'Status unknown')"
            echo "  - Port 5000: $(netstat -tln | grep ':5000' | wc -l) listener(s)"
            echo "  - Deployment dir: $DEPLOY_DIR"
            echo "  - Symlink: $CURRENT_LINK -> $(readlink $CURRENT_LINK)"

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 46.165.254.175
          port: 50103
          username: ituu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          use_insecure_cipher: true
          script: |
            echo "ðŸ¥ Performing health check..."
            
            # Make validation script executable and run it
            chmod +x scripts/validate-deployment.sh
            
            # Run our comprehensive validation script
            if ./scripts/validate-deployment.sh; then
              echo "âœ… Comprehensive health check passed!"
              echo "ðŸŒ Application should be accessible at: https://horus.anatsecurity.fr"
            else
              echo "âš ï¸  Health check completed with some issues"
            fi
            
            # Additional manual checks for GitHub Actions context
            echo ""
            echo "ðŸ“‹ Additional deployment info:"
            echo "  - PM2 Status: $(pm2 show anatscrawler | grep 'status' | awk '{print $4}' || echo 'unknown')"
            echo "  - Port 5000 listeners: $(netstat -tln | grep ':5000' | wc -l)"
            echo "  - Process uptime: $(pm2 show anatscrawler | grep 'uptime' || echo 'unknown')"
            echo "  - Memory usage: $(pm2 show anatscrawler | grep 'memory' || echo 'unknown')"

      - name: Deployment Failed - Debug Info
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 46.165.254.175
          port: 50103
          username: ituu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          use_insecure_cipher: true
          script: |
            echo "ðŸš¨ Deployment failed! Gathering debug information..."
            
            source /tmp/deploy_dir.sh || echo "Warning: Could not source deploy directory"
            
            echo "ðŸ“ Current deployment directory: ${DEPLOY_DIR:-'unknown'}"
            
            if [ -n "$DEPLOY_DIR" ] && [ -d "$DEPLOY_DIR" ]; then
              cd "$DEPLOY_DIR"
              echo "ðŸ“‹ Deployment directory contents:"
              ls -la
              
              echo "ðŸ“‹ Build outputs:"
              ls -la dist/ 2>/dev/null || echo "No dist directory"
              ls -la client/dist/ 2>/dev/null || echo "No client/dist directory"
            fi
            
            echo "ðŸ“Š PM2 Status:"
            pm2 ls
            
            echo "ðŸ“Š PM2 Logs (last 50 lines):"
            pm2 logs anatscrawler --lines 50 || echo "No PM2 logs available"
            
            echo "ðŸ“Š System processes on port 5000:"
            lsof -i :5000 || echo "No processes on port 5000"
            
            echo "ðŸ“Š Network listeners:"
            netstat -tln | grep LISTEN
            
            echo "ðŸ“Š System resources:"
            free -h
            df -h /var/www
            
            echo "ðŸ“Š Recent system logs:"
            journalctl -n 20 --no-pager || echo "Cannot access system logs"
